<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-type" content="text/html; charset=utf-8">
<title>Socket</title>
<script src="build.js"></script>
</head>
<body>
	<h1>sockets</h1>

<script>
// let's invite Firefox to the party.
if (window.MozWebSocket) {
	window.WebSocket = window.MozWebSocket;
}

var WebSocketInterface = function(url){
	var conn = new WebSocket(url);
 
	var callbacks = {};
 
	this.on = function(event_name, callback){
		callbacks[event_name] = callbacks[event_name] || [];
		callbacks[event_name].push(callback);
		return this;// chainable
	};

	this.trigger = function(event_name, event_data){
		var payload = JSON.stringify({event:event_name, data: event_data});
		conn.send( payload ); // <= send JSON data to socket server
		return this;
	};
 
	// dispatch to the right handlers
	conn.onmessage = function(evt){
		try{
			var json = JSON.parse(evt.data);
			dispatch(json.event, json.data)
		}
		catch(er) {
			console.log("socket: unreadable message: %s",evt.data);
		};
	};
 
	conn.onclose = function(){dispatch('close',null)}
	conn.onopen = function(ev){dispatch('open',{timeStamp:ev.timeStamp})}
 
	var dispatch = function(event_name, message){
		var chain = callbacks[event_name];
		if(typeof chain == 'undefined') return; // no callbacks for this event
		for(var i = 0; i < chain.length; i++){
			chain[i]( message )
		}
	}
};

socket = new WebSocketInterface('ws://localhost:8902');

/*socket.on('') = function(evt){
//	console.log("socket: on message event",evt)
	try {
		var data = JSON.parse(evt.data);
	} catch(er) {
		console.log("socket: new unparsable message: %s",evt.data)
	}
	
}*/

socket.on('open',function(d) {
//	console.log("socket: opened, %o ",ev);
	console.log("socket: connected %d", d.timeStamp);
});

window.setTimeout(function(){
	socket.trigger( "Thank you, Mr. server!");
},100);

window.setTimeout(function(){
	socket.trigger({json:true});
},200);

</script>

</body>
</html>