<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<title>Socket</title>
	
</head>
<body>
	<h1>sockets</h1>

<div id="status"></div>
<div id="log"></div>
<div>
	<form>
		<input id="chat">
	</form>
</div>
<script>
// let's invite Firefox to the party.
if (window.MozWebSocket) {
	window.WebSocket = window.MozWebSocket;
}

var state = document.getElementById("state");

function openConnection() {
	// uses global 'conn' object
	if (conn.readyState === undefined || conn.readyState > 1) {
		conn = new WebSocket('ws://localhost:8902');
		conn.onopen = function () {
			state.className = 'success';
			state.innerHTML = 'Socket open';
		};

		conn.onmessage = function (event) {
			// console.log(event.data);
			var message = event.data; //JSON.parse(event.data);
			if (!(/^\d+$/).test(message)) {
				log.innerHTML = '<li class="them">' + message.replace(/[<>&]/g, function (m) { return entities[m]; }) + '</li>' + log.innerHTML;
			} else {
				connected.innerHTML = message;
			}
		};
		
		conn.onclose = function (event) {
			state.className = 'fail';
			state.innerHTML = 'Socket closed';
		};
	}
}

var connected = document.getElementById('connected'),
		log = document.getElementById('log'),
		chat = document.getElementById('chat'),
		form = chat.form,
		conn = {},
		state = document.getElementById('status'),
		entities = {
			'<' : '&lt;',
			'>' : '&gt;',
			'&' : '&amp;'
		};

window.addEventListener("load", function(){
	if (window.WebSocket === undefined) {
		state.innerHTML = 'Sockets not supported';
		state.className = 'fail';
	} else {
		state.onclick = function () {
			if (conn.readyState !== 1) {
				conn.close();
				setTimeout(function () {
					openConnection();
				}, 250);
			}
		};
	
		form.addEventListener('submit', function (event) {
			event.preventDefault();

			// if we're connected
			if (conn.readyState === 1) {
				conn.send(JSON.stringify(chat.value));
				log.innerHTML = '<li class="you">' + chat.value.replace(/[<>&]/g, function (m) { return entities[m]; }) + '</li>' + log.innerHTML;
			
				chat.value = '';
			}
		});

		openConnection();	 
	}
})


</script>

</body>
</html>